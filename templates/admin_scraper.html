{% extends "base.html" %}

{% block title %}Automação do Cardápio{% endblock %}

{% block content %}
<style>
    .scraper-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }

    @media (max-width: 900px) {
        .scraper-grid {
            grid-template-columns: 1fr;
        }
    }

    .stat-card {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 12px;
        padding: 15px;
        margin-top: 15px;
    }

    .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat-row:last-child {
        border-bottom: none;
    }

    /* Better form controls */
    .radio-group {
        display: flex;
        gap: 25px;
        background: rgba(255, 255, 255, 0.03);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .radio-group label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        color: var(--text-muted);
        transition: color 0.2s;
        font-weight: 500;
    }

    .radio-group label:hover {
        color: white;
    }

    .radio-group input[type="radio"] {
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        margin: 0;
        position: relative;
        cursor: pointer;
        transition: all 0.2s;
    }

    .radio-group input[type="radio"]:checked {
        border-color: var(--accent-cyan);
        background: var(--accent-cyan);
        box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
    }

    .radio-group input[type="radio"]:checked::after {
        content: '';
        position: absolute;
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .form-control {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--accent-cyan);
        background: rgba(0, 0, 0, 0.5);
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    .checkbox-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .checkbox-wrapper:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .checkbox-wrapper input[type="checkbox"] {
        appearance: none;
        width: 22px;
        height: 22px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        margin: 0;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
    }

    .checkbox-wrapper input[type="checkbox"]:checked {
        background: var(--accent-cyan);
        border-color: var(--accent-cyan);
        box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
    }

    .checkbox-wrapper input[type="checkbox"]:checked::after {
        content: '✓';
        position: absolute;
        color: white;
        font-size: 16px;
        font-weight: bold;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
</style>

<div class="glass-panel" style="padding: 30px;">
    <h2><i class="ph ph-robot"></i> Automação de Cardápio</h2>
    <p class="text-muted">Sincronize seus itens com o Anota AI automaticamente.</p>

    {% if not store %}
    <div class="card" style="margin-top: 20px; background: rgba(255, 193, 7, 0.1); border-color: var(--accent-yellow);">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i class="ph ph-warning-circle" style="font-size: 32px; color: var(--accent-yellow);"></i>
            <div>
                <h4 style="margin: 0; color: var(--accent-yellow);">Selecione uma Loja</h4>
                <p style="margin: 5px 0 0 0;">Escolha a loja que deseja configurar o scraper.</p>
            </div>
        </div>
    </div>

    <style>
        /* Custom Select Styling */
        .custom-select-wrapper {
            position: relative;
            max-width: 400px;
        }

        .custom-select {
            width: 100%;
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            appearance: none;
            -webkit-appearance: none;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .custom-select:focus {
            outline: none;
            background-color: rgba(0, 0, 0, 0.5);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .custom-select option {
            background-color: #1a1a2e;
            /* Fallback dark */
            color: white;
            padding: 10px;
        }

        .select-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-muted);
            transition: color 0.2s;
        }

        .custom-select:focus+.select-icon {
            color: var(--accent-cyan);
        }
    </style>
    <form method="GET" style="margin-top: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-muted);">Escolha a
            Loja:</label>
        <div class="custom-select-wrapper">
            <select name="store_id" onchange="this.form.submit()" class="custom-select">
                <option value="" style="color: var(--text-muted);">Selecione uma loja...</option>
                {% for s in stores %}
                <option value="{{ s.id }}" {% if store and store.id==s.id %}selected{% endif %}>{{ s.name }}</option>
                {% endfor %}
            </select>
            <i class="ph ph-caret-down select-icon"></i>
        </div>
    </form>
    {% else %}

    <div class="card" style="margin-top: 20px; background: rgba(0, 212, 255, 0.05); border-color: var(--accent-cyan);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <i class="ph ph-storefront" style="font-size: 32px; color: var(--accent-cyan);"></i>
                <div>
                    <h3 style="margin: 0;">{{ store.name }}</h3>
                    <p class="text-muted" style="margin: 5px 0 0 0;"><i class="ph ph-buildings"></i> Subsite: {{
                        store.subsite.name }}</p>
                </div>
            </div>
            <a href="{{ url_for('admin.scraper') }}" class="btn-secondary">
                <i class="ph ph-arrow-left"></i> Trocar Loja
            </a>
        </div>
    </div>

    <div class="scraper-grid">
        <!-- Manual Actions -->
        <div class="card">
            <h4><i class="ph ph-hand-tap"></i> Ações Manuais</h4>
            <p class="text-muted"><small>Execute agora fora do agendamento.</small></p>

            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                <!-- Update Button -->
                <form method="POST" action="{{ url_for('admin.scraper_run') }}">
                    <input type="hidden" name="store_id" value="{{ store.id }}">
                    <input type="hidden" name="mode" value="update">
                    <button type="submit" class="btn-neon" style="width: 100%;">
                        <i class="ph ph-arrows-clockwise"></i> Atualizar Preços/Status
                    </button>
                </form>

                <!-- Insert Button -->
                <form method="POST" action="{{ url_for('admin.scraper_run') }}">
                    <input type="hidden" name="store_id" value="{{ store.id }}">
                    <input type="hidden" name="mode" value="insert">
                    <button type="submit" class="btn-secondary" style="width: 100%;"
                        onclick="return confirm('Isso irá adicionar novos itens encontrados no site ao seu banco de dados. Continuar?')">
                        <i class="ph ph-plus-circle"></i> Inserir Novos Itens
                    </button>
                </form>
            </div>

            <!-- Scraper Status Indicator -->
            <div id="scraper-status"
                style="margin-top: 15px; display: none; align-items: center; gap: 10px; padding: 10px; background: rgba(0, 255, 255, 0.1); border-radius: 8px; border: 1px solid var(--accent-cyan);">
                <i class="ph ph-spinner-gap"
                    style="animation: spin 1.5s linear infinite; font-size: 1.2em; color: var(--accent-cyan);"></i>
                <span style="font-weight: 500; color: var(--accent-cyan);">Scraper em execução...</span>
            </div>

            {% if config.last_run %}
            <div class="stat-card">
                <div class="stat-row">
                    <span class="text-muted"><i class="ph ph-clock"></i> Última Execução:</span>
                    <strong>{{ config.last_run }}</strong>
                </div>
                {% if config.last_stats %}
                <div class="stat-row">
                    <span class="text-muted"><i class="ph ph-check"></i> Atualizados:</span>
                    <strong style="color: var(--accent-cyan);">{{ config.last_stats.get('updated', 0) }}</strong>
                </div>
                <div class="stat-row">
                    <span class="text-muted"><i class="ph ph-plus"></i> Criados:</span>
                    <strong style="color: var(--success);">{{ config.last_stats.get('created', 0) }}</strong>
                </div>
                <div class="stat-row">
                    <span class="text-muted"><i class="ph ph-x"></i> Desativados:</span>
                    <strong style="color: var(--danger);">{{ config.last_stats.get('deactivated', 0) }}</strong>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Scheduling Config -->
        <div class="card">
            <h4><i class="ph ph-calendar-check"></i> Agendamento Automático</h4>
            <form method="POST" action="{{ url_for('admin.scraper_schedule') }}">
                <input type="hidden" name="store_id" value="{{ store.id }}">


                <div class="form-group">
                    <label>URL do Cardápio (Anota AI)</label>
                    <input type="text" name="url" value="{{ config.url or 'https://app.anota.ai/m/JLS7eh7xw' }}"
                        class="form-control" placeholder="https://app.anota.ai/m/...">
                </div>

                <div class="form-group">
                    <label style="margin-bottom: 15px; display: block; font-weight: 600;">Tipo de Agendamento</label>

                    <div class="chip-group" style="margin-bottom: 20px;">
                        <label class="chip-wrapper">
                            <input type="radio" name="schedule_type" value="interval" {% if config.schedule_type
                                !='fixed' %}checked{% endif %} onclick="toggleSchedule('interval')">
                            <span class="chip">Intervalo (Repetir)</span>
                        </label>
                        <label class="chip-wrapper">
                            <input type="radio" name="schedule_type" value="fixed" {% if config.schedule_type=='fixed'
                                %}checked{% endif %} onclick="toggleSchedule('fixed')">
                            <span class="chip">Horário Fixo</span>
                        </label>
                    </div>

                    <!-- Interval Options -->
                    <div id="interval-options"
                        style="display: {% if config.schedule_type=='fixed' %}none{% else %}block{% endif %}; margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 500;">Intervalo de Tempo</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div>
                                <label style="font-size: 0.8em; color: var(--text-muted);">Horas</label>
                                <input type="number" name="interval_hours" value="{{ config.interval_hours or 0 }}"
                                    min="0" max="48" class="form-control" style="width: 80px;">
                            </div>
                            <span style="font-size: 20px; color: var(--text-muted);">:</span>
                            <div>
                                <label style="font-size: 0.8em; color: var(--text-muted);">Minutos</label>
                                <input type="number" name="interval_minutes" value="{{ config.interval_minutes or 0 }}"
                                    min="0" max="59" class="form-control" style="width: 80px;">
                            </div>
                            <span style="font-size: 20px; color: var(--text-muted);">:</span>
                            <div>
                                <label style="font-size: 0.8em; color: var(--text-muted);">Segundos</label>
                                <input type="number" name="interval_seconds" value="{{ config.interval_seconds or 0 }}"
                                    min="0" max="59" class="form-control" style="width: 80px;">
                            </div>
                        </div>
                        <small class="text-muted" style="display: block; margin-top: 10px;">
                            <i class="ph ph-info"></i> O robô executará a cada período definido.
                        </small>
                    </div>

                    <!-- Fixed Time Options -->
                    <!-- Fixed Time Options -->
                    <div id="fixed-options"
                        style="display: {% if config.schedule_type !='fixed' %}none{% else %}block{% endif %}; margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">

                        <!-- 1. Time Input (Prominent) -->
                        <div class="form-group"
                            style="margin-bottom: 20px; display: flex; flex-direction: column; align-items: center;">
                            <label
                                style="font-weight: 500; display: block; margin-bottom: 8px; font-size: 1.1em;">Horário
                                de Execução</label>
                            <input type="time" name="fixed_time" value="{{ config.fixed_time or '04:00' }}"
                                class="form-control"
                                style="width: 180px; height: 50px; font-size: 1.5em; text-align: center;">
                        </div>

                        <!-- 2. Repetition (Radio Chips) -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="font-weight: 500; display: block; margin-bottom: 8px;">Repetir</label>
                            <div class="chip-group" style="justify-content: center;">
                                <label class="chip-wrapper">
                                    <input type="radio" name="fixed_frequency" value="daily" {% if
                                        config.fixed_frequency=='daily' or not config.fixed_frequency %}checked{% endif
                                        %} onclick="toggleFrequency('daily')">
                                    <span class="chip">Diariamente</span>
                                </label>
                                <label class="chip-wrapper">
                                    <input type="radio" name="fixed_frequency" value="weekly" {% if
                                        config.fixed_frequency=='weekly' %}checked{% endif %}
                                        onclick="toggleFrequency('weekly')">
                                    <span class="chip">Semanalmente</span>
                                </label>
                                <label class="chip-wrapper">
                                    <input type="radio" name="fixed_frequency" value="monthly" {% if
                                        config.fixed_frequency=='monthly' %}checked{% endif %}
                                        onclick="toggleFrequency('monthly')">
                                    <span class="chip">Mensalmente</span>
                                </label>
                            </div>
                        </div>

                        <!-- 3. Weekly Days (Circle Chips) -->
                        <div id="weekly-days"
                            style="margin-top: 15px; display: {% if config.fixed_frequency == 'weekly' %}block{% else %}none{% endif %};">
                            <label
                                style="font-weight: 500; display: block; margin-bottom: 10px; text-align: center;">Dias
                                da Semana</label>
                            <div class="chip-group" style="justify-content: center; gap: 8px;">
                                {% set week_days = [
                                {'val': 6, 'lbl': 'D', 'name': 'Domingo'},
                                {'val': 0, 'lbl': 'S', 'name': 'Segunda'},
                                {'val': 1, 'lbl': 'T', 'name': 'Terça'},
                                {'val': 2, 'lbl': 'Q', 'name': 'Quarta'},
                                {'val': 3, 'lbl': 'Q', 'name': 'Quinta'},
                                {'val': 4, 'lbl': 'S', 'name': 'Sexta'},
                                {'val': 5, 'lbl': 'S', 'name': 'Sábado'}
                                ] %}
                                {% for day in week_days %}
                                <label class="chip-wrapper">
                                    <input type="checkbox" name="weekly_days" value="{{ day.val }}" {% if
                                        config.weekly_days and day.val in config.weekly_days %}checked{% endif %}>
                                    <span class="chip"
                                        style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: 600;"
                                        title="{{ day.name }}">
                                        {{ day.lbl }}
                                    </span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- 4. Monthly Days (Circle Chips) -->
                        <div id="monthly-days"
                            style="margin-top: 15px; display: {% if config.fixed_frequency == 'monthly' %}block{% else %}none{% endif %};">
                            <label
                                style="font-weight: 500; display: block; margin-bottom: 10px; text-align: center;">Dias
                                do Mês</label>
                            <div class="chip-group" style="justify-content: center; flex-wrap: wrap; gap: 5px;">
                                {% for d in range(1,32) %}
                                <label class="chip-wrapper">
                                    <input type="checkbox" name="monthly_days" value="{{ d }}" {% if config.monthly_days
                                        and d in config.monthly_days %}checked{% endif %}>
                                    <span class="chip"
                                        style="width: 35px; height: 35px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 0.9em;">{{
                                        d }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Optional Progress Bar (placeholder) -->
                    <div id="scraper-progress" hidden style="margin-top: 10px;">
                        <label style="font-weight: 500;">Progresso</label>
                        <div
                            style="background: var(--bg-muted); width: 100%; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="progress-bar"
                                style="background: var(--accent-cyan); width: 0%; height: 100%; transition: width 0.5s;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" name="active" value="true" {% if config.active %}checked{% endif %}>
                        <strong>Ativar Agendamento Automático</strong>
                    </label>
                </div>

                <button type="submit" class="btn-neon" style="width: 100%; margin-top: 20px;">
                    <i class="ph ph-floppy-disk"></i> Salvar Configuração
                </button>
            </form>
        </div>
    </div>
</div>

{% endif %}
</div>

<script>
    function toggleSchedule(type) {
        if (type === 'interval') {
            document.getElementById('interval-options').style.display = 'block';
            document.getElementById('fixed-options').style.display = 'none';
        } else {
            document.getElementById('interval-options').style.display = 'none';
            document.getElementById('fixed-options').style.display = 'block';
        }
    }

    function toggleFrequency(freq) {
        // Toggle visibility of chip groups using display style for reliability
        document.getElementById('weekly-days').style.display = (freq === 'weekly') ? 'block' : 'none';
        document.getElementById('monthly-days').style.display = (freq === 'monthly') ? 'block' : 'none';
    }

    // Improve loading detection
    document.addEventListener('DOMContentLoaded', function () {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            if (form.action.includes('scraper') || form.id === 'manual-run-form') {
                form.addEventListener('submit', function () {
                    const status = document.getElementById('scraper-status');
                    if (status) {
                        status.style.display = 'flex';
                        status.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            }
        });
    });
</script>
{% endblock %}