{% extends "base.html" %}

{% block title %}Detalhes do Pedido #{{ order.id }}{% endblock %}

{% block content %}
<div class="glass-panel" style="max-width: 900px; margin: 30px auto; padding: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2><i class="ph ph-receipt"></i> Pedido #{{ order.id }}</h2>
        <a href="{{ url_for('admin.orders') }}" class="btn-secondary">
            <i class="ph ph-arrow-left"></i> Voltar
        </a>
    </div>

    <!-- Order Info -->
    <div class="card" style="background: rgba(255,255,255,0.03);">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <p style="color: var(--text-muted); margin-bottom: 5px;">Cliente</p>
                <p style="font-size: 18px;"><strong>{{ order.user.name }}</strong></p>
                <p style="font-size: 14px; color: var(--text-muted);">
                    Chave: {{ order.user.petro_key }} | Tel: {{ order.user.phone or '-' }}
                </p>
            </div>

            <div>
                <p style="color: var(--text-muted); margin-bottom: 5px;">Data do Pedido</p>
                <p style="font-size: 18px;">{{ order.created_at.strftime('%d/%m/%Y às %H:%M') }}</p>
            </div>

            <div>
                <p style="color: var(--text-muted); margin-bottom: 5px;">Local de Entrega</p>
                <p style="font-size: 18px;">
                    <i class="ph ph-map-pin"></i> {{ order.sector.name if order.sector else 'Não especificado' }}
                </p>
            </div>

            <div>
                <p style="color: var(--text-muted); margin-bottom: 5px;">Status</p>
                <p
                    style="font-size: 18px; color: {{ 'var(--success)' if order.status.name == 'Entregue' else 'var(--accent-cyan)' }};">
                    {{ order.status.name }}
                </p>
            </div>
        </div>
    </div>

    <!-- Items -->
    <h3 style="margin-top: 30px; margin-bottom: 15px;">
        <i class="ph ph-shopping-bag"></i> Itens do Pedido
    </h3>

    {% for order_item in order.order_items %}
    <div class="card" style="margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
                <h4 style="margin: 0 0 10px 0;">{{ order_item.item.name if order_item.item else 'Item Removido' }}</h4>

                <!-- Sub-items if any -->
                {% if order_item.subitems_json %}
                <div style="margin-left: 15px; font-size: 14px; color: var(--text-muted);">
                    {% for group in order_item.subitems_json %}
                    <div style="margin: 5px 0;">
                        <strong>{{ group.group }}:</strong>
                        {% if group.type == 'radio' %}
                        {{ group.option }}
                        {% if group.price > 0 %}
                        <span style="color: var(--accent-cyan);">+R$ {{ "%.2f"|format(group.price) }}</span>
                        {% endif %}
                        {% else %}
                        {% for opt in group.options %}
                        {{ opt.option }} x{{ opt.qty }}
                        {% if opt.price > 0 %}
                        <span style="color: var(--accent-cyan);">+R$ {{ "%.2f"|format(opt.price * opt.qty) }}</span>
                        {% endif %}
                        {% if not loop.last %}, {% endif %}
                        {% endfor %}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <p style="margin-top: 10px; color: var(--text-muted);">
                    R$ {{ "%.2f"|format(order_item.price_at_moment) }} × {{ order_item.quantity }}
                </p>
            </div>

            <div style="text-align: right;">
                <p style="font-size: 20px; font-weight: bold; color: var(--success);">
                    R$ {{ "%.2f"|format(order_item.subtotal) }}
                </p>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Totals -->
    <div class="card" style="background: rgba(0,212,255,0.05); border: 1px solid var(--accent-cyan); margin-top: 30px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Subtotal dos Itens:</span>
            <span>R$ {{ "%.2f"|format(order.total_items) }}</span>
        </div>

        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Taxa Fixa:</span>
            <span>R$ {{ "%.2f"|format(order.tax_fixed) }}</span>
        </div>

        <div
            style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <span>Taxa de Serviço:</span>
            <span>R$ {{ "%.2f"|format(order.service_fee) }}</span>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <strong style="font-size: 20px;">Total Geral:</strong>
            <strong style="font-size: 28px; color: var(--success);">
                R$ {{ "%.2f"|format(order.total_general) }}
            </strong>
        </div>
    </div>

    <!-- Payment Info -->
    {% if order.payment_required %}
    <div class="card"
        style="margin-top: 20px; background: rgba(168,85,247,0.05); border: 1px solid var(--accent-purple);">
        <p style="margin: 0;">
            <i class="ph ph-currency-circle-dollar"></i>
            <strong>Pagamento Requerido</strong>
        </p>
        <p style="margin: 10px 0 0 0; font-size: 14px; color: var(--text-muted);">
            Status: {{ order.payment_status }}
            {% if order.pix_charge_id %}
            | PIX ID: {{ order.pix_charge_id }}
            {% endif %}
        </p>
    </div>
    {% endif %}

    <!-- Metadata Form (Status/Totals/Sector) -->
    <form method="POST" action="{{ url_for('admin.update_order_metadata', order_id=order.id) }}">
        <!-- Order Info -->
        <div class="card" style="background: rgba(255,255,255,0.03);">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <strong style="font-size: 1.2em;">{{ order.user.name }}</strong>
                    <div style="font-size: 0.9em; color: var(--text-muted);">
                        Chave: {{ order.user.petro_key }}
                        <br>
                        Data: {{ order.created_at.strftime('%d/%m %H:%M') }}
                    </div>
                </div>

                <div>
                    <label style="color: var(--text-muted); font-size: 0.8em; display: block;">Local</label>
                    <select name="sector_id" class="input-field" style="width: 100%; padding: 5px;">
                        {% for sector in sectors %}
                        <option value="{{ sector.id }}" {% if order.sector_id==sector.id %}selected{% endif %}>
                            {{ sector.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label style="color: var(--text-muted); font-size: 0.8em; display: block;">Status Pedido</label>
                    <select name="status_id" class="input-field" style="width: 100%; padding: 5px;">
                        {% for status in statuses %}
                        <option value="{{ status.id }}" {% if order.status_id==status.id %}selected{% endif %}>
                            {{ status.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label style="color: var(--text-muted); font-size: 0.8em; display: block;">Status Pagamento</label>
                    <select name="payment_status" class="input-field" style="width: 100%; padding: 5px;">
                        <option value="pending" {% if order.payment_status=='pending' %}selected{% endif %}>Pendente
                        </option>
                        <option value="approved" {% if order.payment_status=='approved' %}selected{% endif %}>Aprovado
                        </option>
                        <option value="rejected" {% if order.payment_status=='rejected' %}selected{% endif %}>Rejeitado
                        </option>
                        <option value="refunded" {% if order.payment_status=='refunded' %}selected{% endif %}>
                            Reembolsado</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Items List (Visual Edit) -->
        <h3 style="margin-top: 30px; margin-bottom: 15px;">Itens do Pedido</h3>

        <div id="items-list">
            {% for order_item in order.order_items %}
            <div class="card"
                style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05);">
                <div>
                    <h4 style="margin: 0; color: var(--accent-cyan);">
                        {{ order_item.quantity }}x {{ order_item.item.name if order_item.item else 'Item Removido' }}
                    </h4>

                    {% if order_item.subitems_json %}
                    <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 5px;">
                        {% for group in order_item.subitems_json %}
                        {% if group.type == 'radio' %}
                        {{ group.option }}
                        {% else %}
                        {% for opt in group.options %}
                        {{ opt.option }} x{{ opt.qty }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        {% endif %}
                        {% if not loop.last %} | {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="font-weight: bold;">R$ {{ "%.2f"|format(order_item.subtotal) }}</span>

                    {% if order_item.item %}
                    <a href="{{ url_for('admin.configure_order_item', order_id=order.id, item_id=order_item.item.id, order_item_id=order_item.id) }}"
                        class="icon-btn minimal" title="Editar Completo">
                        <i class="ph ph-pencil-simple"></i>
                    </a>
                    {% endif %}

                    <button type="submit" form="delete-form-{{ order_item.id }}" class="icon-btn minimal"
                        title="Remover" style="color: var(--danger);">
                        <i class="ph ph-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Add Item -->
        <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
            <select id="newItemSelect" class="input-field" style="flex: 1;">
                <option value="">-- Adicionar Novo Item --</option>
                {% for i in items %}
                <option value="{{ i.id }}">{{ i.name }} - R$ {{ "%.2f"|format(i.price) }}</option>
                {% endfor %}
            </select>
            <button type="button" class="btn-secondary" onclick="goToAddItem()">
                <i class="ph ph-plus"></i> Configurar e Adicionar
            </button>
        </div>

        <!-- Totals (Editable) -->
        <div class="card" style="margin-top: 30px; border-color: var(--accent-cyan); background: rgba(0,212,255,0.02);">
            <h4 style="margin-top: 0; color: var(--accent-cyan);">Totais e Valores</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                <div>
                    <label style="font-size: 0.8em; display: block;">Subtotal</label>
                    <input type="number" step="0.01" name="total_items" value="{{ " %.2f"|format(order.total_items) }}"
                        class="input-field">
                </div>
                <div>
                    <label style="font-size: 0.8em; display: block;">Taxa</label>
                    <input type="number" step="0.01" name="tax_fixed" value="{{ " %.2f"|format(order.tax_fixed) }}"
                        class="input-field">
                </div>
                <div>
                    <label style="font-size: 0.8em; display: block;">Serviços</label>
                    <input type="number" step="0.01" name="service_fee" value="{{ " %.2f"|format(order.service_fee) }}"
                        class="input-field">
                </div>
                <div>
                    <label style="font-size: 0.8em; display: block; color: var(--success);">TOTAL</label>
                    <input type="number" step="0.01" name="total_general" value="{{ " %.2f"|format(order.total_general)
                        }}" class="input-field"
                        style="font-weight: bold; color: var(--success); border-color: var(--success);">
                </div>
            </div>

            <div style="text-align: right; margin-top: 15px;">
                <button type="submit" class="btn-neon">
                    <i class="ph ph-floppy-disk"></i> Salvar Alterações Gerais
                </button>
            </div>
        </div>
    </form>

    <!-- Delete Forms -->
    {% for order_item in order.order_items %}
    <form id="delete-form-{{ order_item.id }}" method="POST"
        action="{{ url_for('admin.delete_order_item', order_id=order.id, item_id=order_item.id) }}"
        onsubmit="return confirm('Remover item?');"></form>
    {% endfor %}

    <!-- Actions Footer -->
    <div style="margin-top: 30px; display: flex; gap: 10px;">
        <form method="POST" action="{{ url_for('admin.delete_order', order_id=order.id) }}" style="flex: 1;"
            onsubmit="return confirm('Excluir pedido inteiro?');">
            <button type="submit" class="btn-secondary" style="width: 100%; color: var(--danger);">Excluir
                Pedido</button>
        </form>
        <a href="{{ url_for('admin.orders') }}" class="btn-secondary" style="flex: 1; text-align: center;">Voltar</a>
    </div>

    <script>
        function goToAddItem() {
            const select = document.getElementById('newItemSelect');
            const itemId = select.value;
            if (!itemId) return alert('Selecione um item primeiro.');

            // Redirect to new full page config
            window.location.href = `/admin/order/{{ order.id }}/configure-item/${itemId}`;
        }
    </script>

</div>
{% endblock %}