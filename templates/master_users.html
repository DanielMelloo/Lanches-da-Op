{% extends "base.html" %}

{% block title %}Gerenciar Usuários - Master{% endblock %}

{% block content %}
<style>
    .user-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 100px;
        gap: 15px;
        align-items: center;
        padding: 15px;
        background: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.2s;
    }

    .user-row:hover {
        border-color: var(--accent-cyan);
        background: rgba(255, 255, 255, 0.02);
    }

    .inline-edit-field {
        background: transparent;
        border: 1px solid transparent;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
        width: 100%;
    }

    .inline-edit-field:hover,
    .inline-edit-field:focus {
        background: rgba(0, 0, 0, 0.3);
        border-color: var(--accent-cyan);
        outline: none;
    }

    .key-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 1.1em;
        letter-spacing: 1px;
    }

    /* Minimalist Elements */
    .icon-btn.minimal {
        background: transparent;
        border: none;
        padding: 5px;
        opacity: 0.7;
        transition: all 0.2s;
        cursor: pointer;
    }

    .icon-btn.minimal:hover {
        opacity: 1;
        transform: scale(1.1);
    }

    .minimal-select {
        background: transparent;
        border: none;
        color: var(--text-muted);
        padding: 4px;
        cursor: pointer;
        width: 100%;
        font-size: 0.9em;
    }

    .minimal-select:hover {
        color: white;
    }

    .minimal-select option {
        background: var(--card-bg);
        color: white;
    }
    .role-master { color: var(--accent-purple) !important; font-weight: bold; }
    .role-admin  { color: var(--accent-cyan) !important; font-weight: bold; }
    .role-user   { color: var(--text-muted) !important; font-weight: bold; }

    .status-active { color: var(--success) !important; display: flex; align-items: center; gap: 5px; }
    .status-inactive { color: var(--danger) !important; display: flex; align-items: center; gap: 5px; }
</style>

<div class="glass-panel" style="padding: 30px;">
    <h2><i class="ph ph-users"></i> Gerenciar Usuários</h2>

    <div style="margin: 20px 0;">
        <a href="{{ url_for('master.create_admin') }}" class="btn-neon">
            <i class="ph ph-user-plus"></i> Criar Admin
        </a>
    </div>

    <!-- Users List -->
    <div style="margin-top: 20px;">
        <div class="user-row" style="background: rgba(255,255,255,0.05); font-weight: bold; border: none;">
            <div>Usuário (Nome / Chave / Tel)</div>
            <div>Função</div>
            <div>Subsite</div>
            <div>Status</div>
            <div>Ações</div>
        </div>

        {% for user in users %}
        <div class="user-row">
            <!-- Name, Key, Phone -->
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <!-- Name -->
                <form method="POST" style="margin: 0;">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <input type="hidden" name="action" value="update_name">
                    <input type="text" name="name" value="{{ user.name }}" class="inline-edit-field"
                        onchange="this.form.submit()" style="font-weight: bold; font-size: 1.1em;" placeholder="Nome"
                        title="Nome do usuário">
                </form>

                <!-- Key & Phone -->
                <div style="display: flex; gap: 10px; align-items: center;">
                    <!-- Key -->
                    <form method="POST" style="margin: 0; width: 80px;">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        <input type="hidden" name="action" value="update_key">
                        <input type="text" name="petro_key" value="{{ user.petro_key }}"
                            class="inline-edit-field key-badge" onchange="this.form.submit()"
                            style="text-align: center; color: var(--accent-yellow);" title="Chave Petro (Editar)">
                    </form>

                    <!-- Phone -->
                    <div style="display: flex; align-items: center; gap: 5px; flex: 1;">
                        <form method="POST" action="{{ url_for('master.manage_users', action='update_phone', user_id=user.id) }}" style="display: flex; align-items: center; gap: 8px;">
                            <i class="ph ph-phone" style="font-size: 0.9rem; color: var(--text-muted);"></i>
                            <input type="text" name="phone" value="{{ user.phone or '' }}"
                                class="inline-edit-field phone-mask" onchange="this.form.submit()"
                                style="font-size: 0.9em; color: var(--text-muted); width: 130px;" placeholder="Telefone" title="Telefone">
                        </form>
                        {% if user.phone %}
                        {% set clean_phone = user.phone|replace(' ', '')|replace('-', '')|replace('(', '')|replace(')', '')|replace('+', '') %}
                        {# Ensure Brazilian numbers have 55 prefix #}
                        {% if clean_phone|length == 11 or clean_phone|length == 10 %}
                            {% set final_phone = '55' ~ clean_phone %}
                        {% else %}
                            {% set final_phone = clean_phone %}
                        {% endif %}
                        <a href="https://wa.me/{{ final_phone }}" target="_blank" 
                           class="icon-btn minimal" style="color: #25D366; padding: 0;" title="WhatsApp">
                            <i class="ph ph-whatsapp-logo" style="font-size: 20px;"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Role -->
            <div>
                <form method="POST" style="margin: 0;">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <input type="hidden" name="action" value="update_role">
                    <select name="role" class="minimal-select {{ 'role-master' if user.role == 'admin_master' else ('role-admin' if user.role == 'admin' else 'role-user') }}" onchange="this.form.submit()">
                        <option value="admin_master" {{ 'selected' if user.role == 'admin_master' else '' }}>Master Admin</option>
                        <option value="admin" {{ 'selected' if user.role == 'admin' else '' }}>Admin</option>
                        <option value="user" {{ 'selected' if user.role == 'user' else '' }}>Usuário</option>
                    </select>
                </form>
            </div>

            <!-- Subsite -->
            <div>
                <form method="POST" style="margin: 0;">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <input type="hidden" name="action" value="update_subsite">
                    <select name="subsite_id" class="minimal-select" onchange="this.form.submit()">
                        <option value="">Global / Nenhum</option>
                        {% for subsite in subsites %}
                        <option value="{{ subsite.id }}" {{ 'selected' if user.subsite_id==subsite.id else '' }}>
                            {{ subsite.name }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
            </div>

            <!-- Status -->
            <div>
                <form method="POST" style="margin: 0;">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <input type="hidden" name="action" value="toggle_active">
                    <button type="submit" class="icon-btn minimal" style="width: 100%; text-align: left; padding: 0;"
                        title="Alternar Status">
                        <span class="{{ 'status-active' if user.active else 'status-inactive' }}">
                            <i class="ph {{ 'ph-toggle-right' if user.active else 'ph-toggle-left' }}"
                                style="font-size: 24px;"></i>
                            {{ 'Ativo' if user.active else 'Inativo' }}
                        </span>
                    </button>
                </form>
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 5px;">
                <button class="icon-btn minimal" onclick="alert('TODO: Detalhes do usuário')" title="Detalhes">
                    <i class="ph ph-eye" style="font-size: 20px; color: var(--accent-cyan);"></i>
                </button>
            </div>
        </div>
        {% else %}
        <p class="text-muted" style="text-align: center; padding: 20px;">Nenhum usuário cadastrado.</p>
        {% endfor %}
    </div>

    <div style="margin-top: 30px;">
        <a href="{{ url_for('master.dashboard') }}" class="btn-secondary">
            <i class="ph ph-house"></i> Voltar
        </a>
    </div>
</div>

<script>
    // Phone Mask
    document.querySelectorAll('.phone-mask').forEach(input => {
        input.addEventListener('input', function (e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });
    });
</script>
{% endblock %}