{% extends "base.html" %}

{% block title %}Gerenciar Lojas{% endblock %}

{% block content %}
<style>
    .store-card {
        background: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.2s;
    }

    .store-card:hover {
        border-color: var(--accent-cyan);
        background: rgba(255, 255, 255, 0.02);
    }

    .store-icon {
        width: 50px;
        height: 50px;
        background: rgba(0, 255, 136, 0.1);
        color: var(--success);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .store-icon.inactive {
        background: rgba(255, 59, 48, 0.1);
        color: var(--danger);
    }

    .inline-edit {
        background: transparent;
        border: 1px solid transparent;
        color: white;
        font-size: 1.1em;
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 4px;
        transition: all 0.2s;
        width: 100%;
        max-width: 300px;
    }

    .inline-edit:hover,
    .inline-edit:focus {
        background: rgba(0, 0, 0, 0.3);
        border-color: var(--accent-cyan);
        outline: none;
    }

    .icon-btn.minimal {
        background: transparent;
        border: none;
        padding: 5px;
        opacity: 0.7;
        transition: all 0.2s;
    }

    .icon-btn.minimal:hover {
        opacity: 1;
        transform: scale(1.1);
        background: transparent;
        border: none;
    }

    .dispatch-btn {
        background: rgba(37, 211, 102, 0.1);
        color: #25D366;
        border: 1px solid rgba(37, 211, 102, 0.2);
        padding: 8px 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85em;
        font-weight: 700;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid transparent;
    }

    .dispatch-btn:hover {
        background: #25D366;
        color: var(--background-dark);
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2);
    }

    .dispatch-btn:active {
        transform: translateY(0);
    }

    .status-toggle-icon {
        font-size: 28px;
        transition: all 0.2s;
    }

    .status-active {
        color: #00ff88;
    }

    .status-inactive {
        color: #666;
    }
    .chip {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s;
    }
    .chip:hover {
        background: var(--accent-cyan);
        color: #000;
        border-color: var(--accent-cyan);
    }
    .template-editor {
        width: 100%;
        background: #111;
        border: 1px solid #333;
        color: #0f0; /* Terminal vibe or white? simple white is better for text */
        color: #eee;
        padding: 10px;
        border-radius: 6px;
        font-family: 'Consolas', monospace;
        resize: vertical;
    }
    .template-editor:focus {
        outline: none;
        border-color: var(--accent-cyan);
    }
</style>
<script>
    function insertVar(btn, text) {
        // Find the textarea in the same form
        const form = btn.closest('form');
        const textarea = form.querySelector('textarea');
        
        // Insert at cursor
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const value = textarea.value;
        
        textarea.value = value.substring(0, start) + text + value.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + text.length;
        textarea.focus();
    }
</script>

<div class="glass-panel" style="padding: 30px;">
    <h2><i class="ph ph-storefront"></i> Gerenciar Lojas</h2>
    <p class="text-muted">Categorias de produtos (ex: Lanches, Bebidas)</p>

    <!-- New Store Form -->
    <div class="card" style="margin: 30px 0;">
        <h3><i class="ph ph-plus-circle"></i> Nova Loja</h3>
        <form method="POST" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label>Nome da Loja</label>
                <input type="text" name="name" placeholder="Ex: Bebidas Geladas" required>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label>WhatsApp (DDD + N√∫mero)</label>
                <input type="text" name="whatsapp_number" placeholder="5511999999999">
            </div>
            <button type="submit" class="btn-neon"><i class="ph ph-floppy-disk"></i> Criar</button>
        </form>
    </div>

    <!-- Stores List -->
    <h3><i class="ph ph-list"></i> Lojas Cadastradas</h3>

    {% for store in stores %}
    <div class="store-card">
        <div class="store-icon {{ '' if store.active else 'inactive' }}">
            <i class="ph ph-storefront"></i>
        </div>

        <div style="flex: 1; display: flex; flex-direction: column; gap: 5px;">
            <form method="POST" style="margin: 0; display: flex; align-items: center; gap: 10px;">
                <input type="hidden" name="store_id" value="{{ store.id }}">
                <div style="flex: 1;">
                    <input type="text" name="name" value="{{ store.name }}" class="inline-edit"
                        onchange="this.form.submit()" title="Editar Nome">
                </div>
                <div style="flex: 1; display: flex; align-items: center; gap: 5px;">
                    <i class="ph ph-whatsapp-logo" style="color: #25D366;"></i>
                    <input type="text" name="whatsapp_number" value="{{ store.whatsapp_number or '' }}" 
                        class="inline-edit" style="font-size: 0.9em; font-weight: normal; max-width: 150px;"
                        placeholder="WhatsApp" onchange="this.form.submit()" title="Editar WhatsApp">
                </div>
            </form>
            <div style="margin-left: 10px;">
                <small style="color: var(--text-muted);">
                    {{ '‚óè Vis√≠vel no card√°pio' if store.active else '‚óã Oculta' }}
                </small>
            </div>
        </div>
+
        <!-- Template Editor -->
        <div style="width: 100%;">
            <details style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; border: 1px solid rgba(255,255,255,0.05);">
                <summary style="cursor: pointer; color: var(--accent-cyan); font-weight: bold; font-size: 0.9em; user-select: none;">
                    <i class="ph ph-chat-text-dots"></i> Configurar Mensagem WhatsApp
                </summary>
                
                <form method="POST" style="margin-top: 15px;">
                    <input type="hidden" name="store_id" value="{{ store.id }}">
                    <input type="hidden" name="name" value="{{ store.name }}"> <!-- Keep name -->
                    <input type="hidden" name="whatsapp_number" value="{{ store.whatsapp_number }}"> <!-- Keep number -->

                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 0.8em; color: var(--text-muted); display: block; margin-bottom: 5px;">
                            Vari√°veis (Clique para inserir):
                        </label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="chip" onclick="insertVar(this, '{saudacao}')">Sauda√ß√£o</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{loja}')">Loja</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{id_pedido}')">ID Pedido</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{cliente}')">Cliente</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{telefone}')">Telefone</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{endereco}')">Endere√ßo</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{pagamento}')">Pagamento</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{data}')">Data</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{itens}')">Itens (Lista)</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{itens_inline}')">Itens (Linha)</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{total}')">Total</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{observacao}')">Obs</button>
                        </div>
                    </div>

                    <textarea name="whatsapp_template" class="template-editor" rows="6" placeholder="Ol√°! üçî&#10;Pedido {id_pedido} confirmado!&#10;{itens}&#10;Total: {total}&#10;Pagamento: {pagamento}"
                    >{{ store.whatsapp_template or '' }}</textarea>
                    
                    <div style="text-align: right; margin-top: 10px;">
                        <button type="submit" class="btn-primary" style="padding: 5px 15px; font-size: 0.9em;">
                            <i class="ph ph-floppy-disk"></i> Salvar Template
                        </button>
                    </div>
                </form>
            </details>
        </div>


        <div style="display: flex; gap: 12px; align-items: center;">
            <!-- Manual Dispatch -->
            <form method="POST" style="margin: 0;" onsubmit="return confirm('Enviar resumo de pedidos pendentes para {{ store.name }} via WhatsApp?')">
                <input type="hidden" name="store_id" value="{{ store.id }}">
                <input type="hidden" name="action" value="manual_dispatch">
                <button type="submit" class="dispatch-btn" title="Enviar Pedidos Pendentes">
                    <i class="ph-fill ph-whatsapp-logo" style="font-size: 20px;"></i>
                    Enviar Pedidos
                </button>
            </form>

            <div style="height: 30px; width: 1px; background: rgba(255,255,255,0.1); margin: 0 5px;"></div>

            <!-- Status Toggle -->
            <form method="POST" style="margin: 0;">
                <input type="hidden" name="store_id" value="{{ store.id }}">
                <input type="hidden" name="action" value="toggle_active">
                <button type="submit" class="icon-btn minimal" title="{{ 'Desativar' if store.active else 'Ativar' }}">
                    <i class="ph {{ 'ph-toggle-right' if store.active else 'ph-toggle-left' }} status-toggle-icon {{ 'status-active' if store.active else 'status-inactive' }}"></i>
                </button>
            </form>

            <!-- Delete -->
            <form method="POST" style="margin: 0;"
                onsubmit="return confirm('ATEN√á√ÉO: Excluir esta loja apagar√° TODOS os itens associados a ela!\n\nTem certeza?')">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="store_id" value="{{ store.id }}">
                <button type="submit" class="icon-btn minimal" title="Excluir">
                    <i class="ph ph-trash" style="font-size: 24px; color: var(--danger);"></i>
                </button>
            </form>
        </div>
    </div>
    {% else %}
    <p class="text-muted">Nenhuma loja cadastrada.</p>
    {% endfor %}

    <div style="margin-top: 30px;">
        <a href="{{ url_for('admin.items') }}" class="btn-secondary">
            <i class="ph ph-arrow-left"></i> Voltar para Itens
        </a>
    </div>
</div>
{% endblock %}