{% extends "base.html" %}

{% block title %}Gerenciar Lojas
<style>
    /* Modal Styles */
    .custom-modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        display: none; justify-content: center; align-items: center; z-index: 9999;
    }
    .custom-modal {
        background: rgba(30,30,40, 0.95);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 16px;
        padding: 25px;
        width: 90%; max-width: 400px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        color: #fff;
        transform: translateY(20px); opacity: 0;
        transition: all 0.3s ease;
    }
    .custom-modal.active { transform: translateY(0); opacity: 1; }
    .custom-modal h3 { margin-top: 0; color: var(--primary); }
    .custom-modal p { color: #ccc; line-height: 1.5; }
    .custom-modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
    .custom-modal input {
        width: 100%; padding: 10px; margin-top: 10px;
        background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px; color: #fff; outline: none;
    }
    .custom-modal input:focus { border-color: var(--primary); }
</style>

<!-- Generic Modal Container -->
<div id="genericModal" class="custom-modal-overlay">
    <div class="custom-modal">
        <h3 id="modalTitle">Título</h3>
        <div id="modalBody"></div>
        <div id="modalActions" class="custom-modal-actions">
            <!-- Buttons specific to context -->
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<style>
    .store-card {
        background: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.2s;
    }

    .store-card:hover {
        border-color: var(--accent-cyan);
        background: rgba(255, 255, 255, 0.02);
    }

    .store-icon {
        width: 50px;
        height: 50px;
        background: rgba(0, 255, 136, 0.1);
        color: var(--success);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .store-icon.inactive {
        background: rgba(255, 59, 48, 0.1);
        color: var(--danger);
    }

    .inline-edit {
        background: transparent;
        border: 1px solid transparent;
        color: white;
        font-size: 1.1em;
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 4px;
        transition: all 0.2s;
        width: 100%;
        max-width: 300px;
    }

    .inline-edit:hover,
    .inline-edit:focus {
        background: rgba(0, 0, 0, 0.3);
        border-color: var(--accent-cyan);
        outline: none;
    }

    .icon-btn.minimal {
        background: transparent;
        border: none;
        padding: 5px;
        opacity: 0.7;
        transition: all 0.2s;
    }

    .icon-btn.minimal:hover {
        opacity: 1;
        transform: scale(1.1);
        background: transparent;
        border: none;
    }

    .dispatch-btn {
        background: rgba(37, 211, 102, 0.1);
        color: #25D366;
        border: 1px solid rgba(37, 211, 102, 0.2);
        padding: 8px 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85em;
        font-weight: 700;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid transparent;
    }

    .dispatch-btn:hover {
        background: #25D366;
        color: var(--background-dark);
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2);
    }

    .dispatch-btn:active {
        transform: translateY(0);
    }

    .status-toggle-icon {
        font-size: 28px;
        transition: all 0.2s;
    }

    .status-active {
        color: #00ff88;
    }

    .status-inactive {
        color: #666;
    }
    .chip {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s;
    }
    .chip:hover {
        background: var(--accent-cyan);
        color: #000;
        border-color: var(--accent-cyan);
    }
    .template-editor {
        width: 100%;
        background: #111;
        border: 1px solid #333;
        color: #0f0; /* Terminal vibe or white? simple white is better for text */
        color: #eee;
        padding: 10px;
        border-radius: 6px;
        font-family: 'Consolas', monospace;
        resize: vertical;
    }
    .template-editor:focus {
        outline: none;
        border-color: var(--accent-cyan);
    }
    .valid-phone { border-color: #4CAF50 !important; color: #4CAF50 !important; }
    .invalid-phone { border-color: #F44336 !important; color: #F44336 !important; }
</style>
<script>
    function insertVar(btn, text) {
        // Find the textarea in the same form
        const form = btn.closest('form');
        const textarea = form.querySelector('textarea');
        
        // Insert at cursor
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const value = textarea.value;
        
        textarea.value = value.substring(0, start) + text + value.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + text.length;
        textarea.focus();
    }

    function maskPhone(input) {
        let value = input.value.replace(/\D/g, ''); // Strip non-digits
        
        // Limit to 11 digits
        if (value.length > 11) value = value.slice(0, 11);

        // Apply formatting
        if (value.length > 10) {
            // (11) 99999-9999
            value = value.replace(/^(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        } else if (value.length > 6) {
             // (11) 9999-9999
             value = value.replace(/^(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
        } else if (value.length > 2) {
             // (11) 9999
             value = value.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
        } else if (value.length > 0) {
             // (11
             value = value.replace(/^(\d{0,2})/, '($1');
        }
        
        input.value = value;
        validatePhone(input);
    }

    function validatePhone(input) {
        const digits = input.value.replace(/\D/g, '').length;
        const isValid = digits === 10 || digits === 11;
        
        if (input.value.length > 0) {
            if (isValid) {
                input.classList.add('valid-phone');
                input.classList.remove('invalid-phone');
            } else {
                input.classList.add('invalid-phone');
                input.classList.remove('valid-phone');
            }
        } else {
            input.classList.remove('valid-phone', 'invalid-phone');
        }
    }
    
    // --- Modal Logic ---
    function closeModal() {
        const overlay = document.getElementById('genericModal');
        const modal = overlay.querySelector('.custom-modal');
        modal.classList.remove('active');
        setTimeout(() => { overlay.style.display = 'none'; }, 200);
    }

    function showModalCommon(title, bodyHtml, buttonsHtml) {
        const overlay = document.getElementById('genericModal');
        const modal = overlay.querySelector('.custom-modal');
        
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = bodyHtml;
        document.getElementById('modalActions').innerHTML = buttonsHtml;
        
        overlay.style.display = 'flex';
        setTimeout(() => { modal.classList.add('active'); }, 10);
    }

    window.promptModal = function(title, placeholder, onConfirm) {
        const body = `<input type="text" id="modalInput" placeholder="${placeholder}" onkeydown="if(event.key==='Enter') document.getElementById('btnConfirm').click()">`;
        const buttons = `
            <button onclick="closeModal()" class="btn-secondary" style="background:transparent; border:1px solid #555;">Cancelar</button>
            <button id="btnConfirm" class="btn-primary">Salvar</button>
        `;
        showModalCommon(title, body, buttons);
        setTimeout(() => document.getElementById('modalInput').focus(), 100);
        document.getElementById('btnConfirm').onclick = () => {
            const val = document.getElementById('modalInput').value;
            if(val) { closeModal(); onConfirm(val); }
            else { document.getElementById('modalInput').style.borderColor = 'red'; }
        };
    };

    window.confirmModal = function(title, message, onConfirm) {
        const buttons = `
            <button onclick="closeModal()" class="btn-secondary" style="background:transparent; border:1px solid #555;">Não</button>
            <button id="btnConfirm" class="btn-primary" style="background: var(--primary);">Sim</button>
        `;
        showModalCommon(title, `<p>${message}</p>`, buttons);
        document.getElementById('btnConfirm').onclick = () => { closeModal(); onConfirm(); };
    };

    window.alertModal = function(title, message) {
        const buttons = `<button onclick="closeModal()" class="btn-primary">OK</button>`;
        showModalCommon(title, `<p>${message}</p>`, buttons);
    };

    // Auto-mask on load for existing values
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('input[name="whatsapp_number"]').forEach(input => {
             maskPhone(input);
        });
        loadPresets();
    });

    // ===========================
    // Template Presets Logic
    // ===========================
    let presetsData = [];

    async function loadPresets() {
        try {
            const res = await fetch('/admin/templates/list');
            const data = await res.json();
            presetsData = data.presets || [];
            
            const select = document.getElementById('templateSelect');
            select.innerHTML = '<option value="">-- Selecione --</option>';
            
            presetsData.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                select.appendChild(opt);
            });
        } catch (e) {
            console.log(e);
        }
    }

    async function savePreset() {
        const textarea = document.querySelector('textarea[name="whatsapp_template"]');
        const content = textarea.value;
        if(!content) return alertModal('Atenção', 'O modelo está vazio.');
        
        promptModal('Nome do Modelo', 'Ex: Promoção Feriado', async (name) => {
            try {
                const res = await fetch('/admin/templates/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, content})
                });
                const data = await res.json();
                if(data.success) {
                    alertModal('Sucesso', 'Modelo "' + name + '" salvo!');
                    loadPresets();
                } else {
                    alertModal('Erro', data.error || 'Erro desconhecido');
                }
            } catch(e) {
                alertModal('Erro', 'Erro de conexão.');
            }
        });
    }

    function loadPreset(id) {
        if(!id) return;
        const p = presetsData.find(x => x.id == id);
        if(p) {
            confirmModal('Carregar Modelo?', 'Deseja substituir o texto atual pelo modelo "'+p.name+'"?', () => {
                const textarea = document.querySelector('textarea[name="whatsapp_template"]');
                textarea.value = p.content;
            });
        }
    }

    async function deletePreset() {
        const select = document.getElementById('templateSelect');
        const id = select.value;
        if(!id) return alertModal('Atenção', 'Selecione um modelo para excluir.');
        
        confirmModal('Excluir?', 'Tem certeza que deseja apagar este modelo permanentemente?', async () => {
            try {
                const res = await fetch('/admin/templates/' + id, { method: 'DELETE' });
                const data = await res.json();
                if(data.success) {
                    loadPresets();
                    alertModal('Sucesso', 'Modelo excluído.');
                } else {
                    alertModal('Erro', data.error || 'Erro ao excluir');
                }
            } catch(e) {
                alertModal('Erro', 'Erro de conexão.');
            }
        });
    }

<div class="glass-panel" style="padding: 30px;">
    <h2><i class="ph ph-storefront"></i> Gerenciar Lojas</h2>
    <p class="text-muted">Categorias de produtos (ex: Lanches, Bebidas)</p>

    <!-- New Store Form -->
    <div class="card" style="margin: 30px 0;">
        <h3><i class="ph ph-plus-circle"></i> Nova Loja</h3>
        <form method="POST" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label>Nome da Loja</label>
                <input type="text" name="name" placeholder="Ex: Bebidas Geladas" required>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label>WhatsApp</label>
                <input type="text" name="whatsapp_number" placeholder="(11) 99999-9999" 
                    oninput="maskPhone(this)" autocomplete="off">
            </div>
            <button type="submit" class="btn-neon"><i class="ph ph-floppy-disk"></i> Criar</button>
        </form>
    </div>

    <!-- Stores List -->
    <h3><i class="ph ph-list"></i> Lojas Cadastradas</h3>

    {% for store in stores %}
    <div class="store-card">
        <div class="store-icon {{ '' if store.active else 'inactive' }}">
            <i class="ph ph-storefront"></i>
        </div>

        <div style="flex: 1; display: flex; flex-direction: column; gap: 15px;">
            <form method="POST" style="margin: 0; width: 100%;">
                <input type="hidden" name="store_id" value="{{ store.id }}">
                
                <!-- Layout: Name on top, WhatsApp below -->
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    
                    <!-- Store Name -->
                    <div>
                        <label style="font-size: 0.75em; color: var(--text-muted); display: block; margin-bottom: 2px;">Nome da Loja</label>
                        <input type="text" name="name" value="{{ store.name }}" class="inline-edit"
                            style="font-size: 1.1em; font-weight: bold; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1);"
                            onchange="this.form.submit()">
                    </div>

                    <!-- WhatsApp & Status Row -->
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-size: 0.75em; color: var(--text-muted); display: block; margin-bottom: 2px;">WhatsApp</label>
                            <div style="display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 6px;">
                                <i class="ph ph-whatsapp-logo" style="color: #25D366; font-size: 1.2em;"></i>
                                <input type="text" name="whatsapp_number" value="{{ store.whatsapp_number or '' }}" 
                                    class="inline-edit" style="font-size: 1em; width: 100%; border: none;"
                                    placeholder="(11) 99999-9999" oninput="maskPhone(this)" onchange="this.form.submit()">
                            </div>
                        </div>

                        <div style="padding-bottom: 8px; display: flex; align-items: center; gap: 15px;">
                             <!-- Status Indicator -->
                             <small style="color: {{ '#4CAF50' if store.active else 'var(--text-muted)' }}; font-weight: bold;">
                                {{ '● Ativa' if store.active else '○ Oculta' }}
                             </small>

                             <!-- Auto-Send Toggle -->
                             <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;" title="Enviar WhatsApp autom. ao fechar?">
                                <input type="checkbox" name="auto_send_on_close" value="true" 
                                    {{ 'checked' if store.auto_send_on_close else '' }} 
                                    onchange="this.form.submit()">
                                <span style="font-size: 0.8em; color: #ccc;">Auto-Envio</span>
                             </label>
                        </div>
                    </div>

                </div>
            </form>
        </div>
        <!-- Template Editor -->
        <div style="width: 100%;">
            <details style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; border: 1px solid rgba(255,255,255,0.05);">
                <summary style="cursor: pointer; color: var(--accent-cyan); font-weight: bold; font-size: 0.9em; user-select: none;">
                    <i class="ph ph-chat-text-dots"></i> Configurar Mensagem WhatsApp
                </summary>
                
                <form method="POST" style="margin-top: 15px;">
                    <input type="hidden" name="store_id" value="{{ store.id }}">
                    <input type="hidden" name="name" value="{{ store.name }}"> <!-- Keep name -->
                    <input type="hidden" name="whatsapp_number" value="{{ store.whatsapp_number }}"> <!-- Keep number -->

                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 0.8em; color: var(--text-muted); display: block; margin-bottom: 5px;">
                            Variáveis (Clique para inserir):
                        </label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="chip" onclick="insertVar(this, '{saudacao}')">Saudação</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{loja}')">Loja</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{id_pedido}')">ID Pedido</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{cliente}')">Cliente</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{telefone}')">Telefone</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{endereco}')">Endereço</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{pagamento}')">Pagamento</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{data}')">Data</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{itens}')">Itens (Lista)</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{itens_inline}')">Itens (Linha)</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{resumo_geral}')" style="border-color: var(--accent-cyan); color: var(--accent-cyan);">Resumo Geral</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{total}')">Total</button>
                            <button type="button" class="chip" onclick="insertVar(this, '{observacao}')">Obs</button>
                        </div>
                    </div>

                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <label style="font-size: 0.9em; color: var(--text-muted);">Modelos Salvos:</label>
                                <select id="templateSelect" class="input-field" style="padding: 5px; min-width: 150px;" onchange="loadPreset(this.value)">
                                    <option value="">-- Selecione --</option>
                                </select>
                                <button type="button" class="icon-btn minimal" onclick="deletePreset()" title="Excluir Modelo" style="color: var(--danger);">
                                    <i class="ph ph-trash"></i>
                                </button>
                            </div>
                            
                            <button type="button" class="btn-secondary" onclick="savePreset()" style="font-size: 0.8em; padding: 5px 15px;">
                                <i class="ph ph-floppy-disk"></i> Salvar Modelo Atual
                            </button>
                        </div>

                        <textarea name="whatsapp_template" class="input-field" rows="12" 
                            style="width: 100%; font-family: monospace; line-height: 1.5; padding: 15px;"
                            placeholder="Olá {cliente}...">{{ store.whatsapp_template }}</textarea>
                    
                    <div style="text-align: right; margin-top: 10px;">
                        <button type="submit" class="btn-primary" style="padding: 5px 15px; font-size: 0.9em;">
                            <i class="ph ph-floppy-disk"></i> Salvar Template
                        </button>
                    </div>
                </form>
            </details>
        </div>


        <div style="display: flex; gap: 12px; align-items: center;">
            <!-- Manual Dispatch -->
            <form method="POST" style="margin: 0;" onsubmit="return confirm('Enviar resumo de pedidos pendentes para {{ store.name }} via WhatsApp?')">
                <input type="hidden" name="store_id" value="{{ store.id }}">
                <input type="hidden" name="action" value="manual_dispatch">
                <button type="submit" class="dispatch-btn" title="Enviar Pedidos Pendentes">
                    <i class="ph-fill ph-whatsapp-logo" style="font-size: 20px;"></i>
                    Enviar Pedidos
                </button>
            </form>

            <div style="height: 30px; width: 1px; background: rgba(255,255,255,0.1); margin: 0 5px;"></div>

            <!-- Status Toggle -->
            <form method="POST" style="margin: 0;">
                <input type="hidden" name="store_id" value="{{ store.id }}">
                <input type="hidden" name="action" value="toggle_active">
                <button type="submit" class="icon-btn minimal" title="{{ 'Desativar' if store.active else 'Ativar' }}">
                    <i class="ph {{ 'ph-toggle-right' if store.active else 'ph-toggle-left' }} status-toggle-icon {{ 'status-active' if store.active else 'status-inactive' }}"></i>
                </button>
            </form>

            <!-- Delete -->
            <form method="POST" style="margin: 0;"
                onsubmit="return confirm('ATENÇÃO: Excluir esta loja apagará TODOS os itens associados a ela!\n\nTem certeza?')">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="store_id" value="{{ store.id }}">
                <button type="submit" class="icon-btn minimal" title="Excluir">
                    <i class="ph ph-trash" style="font-size: 24px; color: var(--danger);"></i>
                </button>
            </form>
        </div>
    </div>
    {% else %}
    <p class="text-muted">Nenhuma loja cadastrada.</p>
    {% endfor %}

    <div style="margin-top: 30px;">
        <a href="{{ url_for('admin.items') }}" class="btn-secondary">
            <i class="ph ph-arrow-left"></i> Voltar para Itens
        </a>
    </div>
</div>
{% endblock %}