<!-- Reusable Subitems Editor Partial -->
<div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;"><i class="ph ph-list-plus"></i> Subitens / Opcionais</h3>
        <button type="button" class="btn-secondary" onclick="addGroup()" style="padding: 5px 15px; font-size: 14px;">
            <i class="ph ph-plus"></i> Adicionar Grupo
        </button>
    </div>
    
    <div id="subitems-container" style="display: grid; gap: 20px;">
        <!-- Groups will be injected here -->
    </div>

    <input type="hidden" name="subitems_json" id="subitems_json_input">
</div>

<template id="group-template">
    <div class="group-card" style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px;">
        <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: start;">
            <div style="flex: 2;">
                <label style="font-size: 12px; color: var(--text-muted);">Título do Grupo (ex: Escolha seu Molho)</label>
                <input type="text" class="group-title input-field" placeholder="Título" style="width: 100%;">
            </div>
            <div style="flex: 1;">
                <label style="font-size: 12px; color: var(--text-muted);">Tipo</label>
                <select class="group-type input-field" style="width: 100%;">
                    <option value="radio">Rádio (escolha 1)</option>
                    <option value="checkbox">Checkbox (múltiplos)</option>
                </select>
            </div>
            <button type="button" class="icon-btn minimal" onclick="this.closest('.group-card').remove()" style="color: var(--danger); margin-top: 25px;">
                <i class="ph ph-trash"></i>
            </button>
        </div>

        <div class="options-container" style="display: grid; gap: 8px; margin-left: 20px; border-left: 2px solid rgba(255,255,255,0.05); padding-left: 15px;">
            <!-- Options go here -->
        </div>
        
        <button type="button" class="btn-secondary" onclick="addOption(this.previousElementSibling)" style="margin-top: 10px; padding: 4px 10px; font-size: 12px; margin-left: 20px;">
            <i class="ph ph-plus"></i> Adicionar Opção
        </button>
    </div>
</template>

<template id="option-template">
    <div class="option-row" style="display: flex; gap: 10px; align-items: center;">
        <div style="flex: 3;">
            <input type="text" class="option-name input-field" placeholder="Nome da Opção" style="width: 100%; font-size: 14px; padding: 6px 10px;">
        </div>
        <div style="flex: 1;">
            <input type="number" step="0.01" class="option-price input-field" placeholder="Preço (0.00)" style="width: 100%; font-size: 14px; padding: 6px 10px;">
        </div>
        <button type="button" class="icon-btn minimal" onclick="this.closest('.option-row').remove()" style="color: var(--danger); padding: 5px;">
            <i class="ph ph-x"></i>
        </button>
    </div>
</template>

<script>
    (function() {
        const container = document.getElementById('subitems-container');
        const groupTemplate = document.getElementById('group-template');
        const optionTemplate = document.getElementById('option-template');
        const initialData = {{ (item.subitems_json if item else []) | tojson | safe }};

        window.addGroup = function(data = null) {
            const clone = groupTemplate.content.cloneNode(true);
            const groupCard = clone.querySelector('.group-card');
            
            if (data) {
                groupCard.querySelector('.group-title').value = data.group || data.title || '';
                groupCard.querySelector('.group-type').value = data.type || 'radio';
                
                const optionsContainer = groupCard.querySelector('.options-container');
                const options = data.options || [];
                
                options.forEach(opt => {
                    addOption(optionsContainer, typeof opt === 'string' ? {name: opt, price: 0} : opt);
                });
            } else {
                addOption(groupCard.querySelector('.options-container'));
            }
            
            container.appendChild(clone);
        };

        window.addOption = function(optionsContainer, data = null) {
            const clone = optionTemplate.content.cloneNode(true);
            if (data) {
                clone.querySelector('.option-name').value = data.name || data.option || '';
                clone.querySelector('.option-price').value = data.price || 0;
            }
            optionsContainer.appendChild(clone);
        };

        window.serializeSubitems = function() {
            const result = [];
            const groups = container.querySelectorAll('.group-card');
            
            groups.forEach(groupCard => {
                const title = groupCard.querySelector('.group-title').value.trim();
                const type = groupCard.querySelector('.group-type').value;
                if (!title) return;

                const options = [];
                groupCard.querySelectorAll('.option-row').forEach(row => {
                    const name = row.querySelector('.option-name').value.trim();
                    const price = parseFloat(row.querySelector('.option-price').value) || 0;
                    if (name) {
                        options.push({ name, price });
                    }
                });

                if (options.length > 0) {
                    result.push({
                        title: title,
                        group: title,
                        type: type,
                        options: options
                    });
                }
            });

            document.getElementById('subitems_json_input').value = JSON.stringify(result);
        };

        // Initialize with existing data if present
        if (initialData && initialData.length > 0) {
            initialData.forEach(g => addGroup(g));
        }
    })();
</script>
