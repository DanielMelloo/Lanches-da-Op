{% extends "base.html" %}

{% block title %}{{ item.name }} - Detalhes{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; padding-bottom: 90px; /* Space for fixed bottom bar */">
    <div class="glass-panel" style="padding: 0; overflow: hidden;">
        <!-- Item Header -->
        <div style="position: relative;">
            {% if item.image_url %}
            <img src="{{ item.image_url }}" alt="{{ item.name }}"
                style="width: 100%; height: 250px; object-fit: cover;">
            {% else %}
            <div
                style="width: 100%; height: 200px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center;">
                <i class="ph ph-image text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
            </div>
            {% endif %}

            <a href="{{ url_for('user.menu', subsite_id=subsite_id) }}" class="btn-icon"
                style="position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%;">
                <i class="ph ph-arrow-left"></i>
            </a>
        </div>

        <div style="padding: var(--spacing-md);">
            <div class="flex justify-between items-start mb-sm">
                <h1 style="font-size: 1.5rem; margin: 0;">{{ item.name }}</h1>
                <span class="text-accent" style="font-size: 1.5rem; font-weight: bold; white-space: nowrap;">
                    R$ <span id="basePriceDisplay">{{ "%.2f"|format(item.price) }}</span>
                </span>
            </div>

            {% if item.description %}
            <p class="text-muted mb-md">{{ item.description }}</p>
            {% endif %}
        </div>
    </div>

    <form method="POST" action="{{ url_for('user.add_to_cart') }}" id="addToCartForm">
        <input type="hidden" name="item_id" value="{{ item.id }}">
        <input type="hidden" name="subsite_id" value="{{ subsite_id }}">
        <input type="hidden" name="subitems_choice" id="subitemsChoiceInput">
        <input type="hidden" name="quantity" id="quantityInput" value="1">

        <!-- Quantity Selector (Main) -->
        <div class="glass-panel mt-md flex justify-between items-center">
            <span style="font-weight: 500;">Quantidade</span>
            <div class="flex items-center gap-md">
                <button type="button" class="btn-icon"
                    style="background: var(--input-bg); border: 1px solid rgba(255,255,255,0.1);"
                    onclick="changeQty(-1)">
                    <i class="ph ph-minus"></i>
                </button>
                <span id="mainQty"
                    style="font-size: 1.25rem; font-weight: bold; min-width: 30px; text-align: center;">1</span>
                <button type="button" class="btn-icon"
                    style="background: var(--input-bg); border: 1px solid rgba(255,255,255,0.1);"
                    onclick="changeQty(1)">
                    <i class="ph ph-plus"></i>
                </button>
            </div>
        </div>

        <!-- Sub-items -->
        {% if item.subitems_json %}
        {% for group in item.subitems_json %}
        {% set outer_loop = loop %}
        <div class="mt-md">
            <h3 class="mb-sm" style="font-size: 1.1rem;">
                {{ group.title }}
                <span class="text-muted" style="font-size: 0.9em; font-weight: normal;">
                    {% if group.type == 'radio' %}(Escolha 1){% else %}(Opcionais){% endif %}
                </span>
            </h3>

            <div class="flex flex-col gap-sm">
                {% for option in group.options %}
                {% set option_name = option.name if option is mapping else option %}
                {% set option_price = option.price if option is mapping else 0 %}

                <label class="card flex items-center gap-md"
                    style="margin: 0; padding: 12px; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); transition: border-color 0.2s;">
                    {% if group.type == 'radio' %}
                    <input type="radio" name="group_{{ outer_loop.index0 }}" value="{{ option_name }}"
                        data-price="{{ option_price }}" onchange="updateTotal(); highlightSelected(this)"
                        style="width: 24px; height: 24px; margin: 0; accent-color: var(--accent-cyan);">
                    {% else %}
                    <input type="checkbox" name="group_{{ outer_loop.index0 }}_{{ loop.index }}"
                        value="{{ option_name }}" data-price="{{ option_price }}" data-group="{{ outer_loop.index0 }}"
                        data-option="{{ loop.index }}"
                        onchange="toggleQtySelector(this); updateTotal(); highlightSelected(this)"
                        style="width: 24px; height: 24px; margin: 0; accent-color: var(--accent-cyan);">
                    {% endif %}

                    <div class="flex-1 flex justify-between items-center">
                        <span>{{ option_name }}</span>
                        {% if option_price > 0 %}
                        <span class="text-accent">+R$ {{ "%.2f"|format(option_price) }}</span>
                        {% endif %}
                    </div>

                    {% if group.type == 'checkbox' %}
                    <div id="qty_{{ outer_loop.index0 }}_{{ loop.index }}" class="flex items-center gap-sm"
                        style="display: none; margin-left: 10px;">
                        <button type="button" class="btn-icon"
                            style="width: 28px; height: 28px; font-size: 1rem; background: var(--bg-dark);"
                            onclick="changeSubitemQty({{ outer_loop.index0 }}, {{ loop.index }}, -1); event.preventDefault();">
                            <i class="ph ph-minus"></i>
                        </button>
                        <span id="qty_val_{{ outer_loop.index0 }}_{{ loop.index }}"
                            style="font-weight: bold; min-width: 15px; text-align: center;">1</span>
                        <button type="button" class="btn-icon"
                            style="width: 28px; height: 28px; font-size: 1rem; background: var(--bg-dark);"
                            onclick="changeSubitemQty({{ outer_loop.index0 }}, {{ loop.index }}, 1); event.preventDefault();">
                            <i class="ph ph-plus"></i>
                        </button>
                    </div>
                    {% endif %}
                </label>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </form>
</div>

<!-- Fixed Bottom Action Bar -->
<div
    style="position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px 20px; background: rgba(11, 18, 32, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000; box-shadow: 0 -4px 20px rgba(0,0,0,0.4);">
    <div class="container" style="display: flex; justify-content: space-between; align-items: center; padding: 0;">
        <div class="flex flex-col">
            <span class="text-muted" style="font-size: 0.8rem; margin-bottom: 2px;">Total</span>
            <span style="font-size: 1.5rem; font-weight: bold; color: var(--success);" id="totalPrice">
                R$ {{ "%.2f"|format(item.price) }}
            </span>
        </div>
        <button type="button" onclick="submitForm()" class="btn-neon" style="min-width: 150px; padding: 0 20px;">
            Adicionar <i class="ph ph-shopping-cart" style="margin-left: 8px;"></i>
        </button>
    </div>
</div>

<script>
    const basePrice = {{ item.price }};
    const subitems = {{ item.subitems_json| tojson if item.subitems_json else '[]' | safe }};
    const subitemQty = {};
    let mainQty = 1;

    // Helper: Highlight selected cards
    function highlightSelected(input) {
        // Remove highlight from all in group if radio
        if (input.type === 'radio') {
            const name = input.name;
            document.querySelectorAll(`input[name="${name}"]`).forEach(el => {
                el.closest('.card').style.borderColor = 'rgba(255,255,255,0.05)';
                el.closest('.card').style.background = '';
            });
        }

        const card = input.closest('.card');
        if (input.checked) {
            card.style.borderColor = 'var(--accent-cyan)';
            card.style.background = 'rgba(0, 212, 255, 0.05)';
        } else {
            card.style.borderColor = 'rgba(255,255,255,0.05)';
            card.style.background = '';
        }
    }

    function changeQty(delta) {
        mainQty = Math.max(1, mainQty + delta);
        document.getElementById('mainQty').textContent = mainQty;
        document.getElementById('quantityInput').value = mainQty;
        updateTotal();
    }

    function toggleQtySelector(checkbox) {
        const group = checkbox.dataset.group;
        const option = checkbox.dataset.option;
        const qtyDiv = document.getElementById(`qty_${group}_${option}`);
        const key = `${group}_${option}`;

        if (checkbox.checked) {
            qtyDiv.style.display = 'flex';
            if (!subitemQty[key]) subitemQty[key] = 1;
        } else {
            qtyDiv.style.display = 'none';
            delete subitemQty[key];
        }
    }

    function changeSubitemQty(group, option, delta) {
        const key = `${group}_${option}`;
        if (!subitemQty[key]) subitemQty[key] = 1;
        subitemQty[key] = Math.max(1, subitemQty[key] + delta);
        document.getElementById(`qty_val_${key}`).textContent = subitemQty[key];
        updateTotal();
    }

    function updateTotal() {
        let total = basePrice;

        // Radios
        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
            total += parseFloat(radio.dataset.price) || 0;
        });

        // Checkboxes
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            const price = parseFloat(checkbox.dataset.price) || 0;
            const group = checkbox.dataset.group;
            const option = checkbox.dataset.option;
            const qty = subitemQty[`${group}_${option}`] || 1;
            total += price * qty;
        });

        const grandTotal = total * mainQty;
        document.getElementById('totalPrice').textContent = `R$ ${grandTotal.toFixed(2)}`;
    }

    function submitForm() {
        // Serialize choices
        const choices = [];

        // Radios
        subitems.forEach((group, index) => {
            if (group.type === 'radio') {
                const selected = document.querySelector(`input[name="group_${index}"]:checked`);
                if (selected) {
                    choices.push({
                        group: group.title,
                        type: 'radio',
                        option: selected.value,
                        price: parseFloat(selected.dataset.price) || 0
                    });
                }
            } else {
                // Checkboxes
                const selectedOptions = [];
                document.querySelectorAll(`input[type="checkbox"][data-group="${index}"]:checked`).forEach(checkbox => {
                    const optionIdx = checkbox.dataset.option;
                    const qty = subitemQty[`${index}_${optionIdx}`] || 1;
                    selectedOptions.push({
                        option: checkbox.value,
                        price: parseFloat(checkbox.dataset.price) || 0,
                        qty: qty
                    });
                });
                if (selectedOptions.length > 0) {
                    choices.push({
                        group: group.title,
                        type: 'checkbox',
                        options: selectedOptions
                    });
                }
            }
        });

        document.getElementById('subitemsChoiceInput').value = JSON.stringify(choices);
        document.getElementById('addToCartForm').submit();
    }
</script>
{% endblock %}