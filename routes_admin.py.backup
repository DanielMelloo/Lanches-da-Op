def require_admin():
    if current_user.role not in ['admin', 'admin_master']:
        flash('Acesso negado.', 'error')
        return redirect(url_for('index'))

@admin_bp.route('/dashboard')
def dashboard():
    # Helper to determine active subsite
    from flask import session
    subsite_id = current_user.subsite_id
    
    if current_user.role == 'admin_master':
        # Master viewing specific subsite
        subsite_id = session.get('master_subsite_id')
        if not subsite_id:
             # If master hasn't selected a subsite, go back to master dashboard
             return redirect(url_for('master.dashboard'))
    
    if not subsite_id:
        flash('Admin sem subsite vinculado.', 'error')
        return redirect(url_for('index'))

    subsite = Subsite.query.get_or_404(subsite_id)
    recent_orders = Order.query.filter_by(subsite_id=subsite_id).order_by(Order.created_at.desc()).limit(10).all()
    
    return render_template('admin_dashboard.html', subsite=subsite, recent_orders=recent_orders)

@admin_bp.route('/orders')
def orders():
    from flask import session
    subsite_id = current_user.subsite_id
    
    if current_user.role == 'admin_master':
        subsite_id = session.get('master_subsite_id')
        if not subsite_id: return redirect(url_for('master.dashboard'))

    if not subsite_id: return redirect(url_for('index'))
    
    status_filter = request.args.get('status_id')
    
    query = Order.query.filter_by(subsite_id=subsite_id)
    if status_filter:
        query = query.filter_by(status_id=status_filter)
        
    all_orders = query.order_by(Order.created_at.desc()).all()
    statuses = Status.query.all()
    
    return render_template('admin_orders.html', orders=all_orders, statuses=statuses, current_status=status_filter)

@admin_bp.route('/order/<int:order_id>/update', methods=['POST'])
def update_order(order_id):
    order = Order.query.get_or_404(order_id)
    if order.subsite_id != current_user.subsite_id and current_user.role != 'admin_master':
         flash('Acesso negado.', 'error')
         return redirect(url_for('admin.orders'))
         
    new_status = request.form.get('status_id')
    if new_status:
        order.status_id = new_status
        db.session.commit()
        flash(f'Pedido #{order.id} atualizado.', 'success')
        
    return redirect(url_for('admin.orders'))

@admin_bp.route('/stores', methods=['GET', 'POST'])
def stores():
    from flask import session
    subsite_id = current_user.subsite_id
    if current_user.role == 'admin_master':
        subsite_id = session.get('master_subsite_id')
    if not subsite_id: return redirect(url_for('index'))

    if request.method == 'POST':
        # Inline Create/Update Store
        store_id = request.form.get('store_id')
        name = request.form.get('name')
        
        if store_id: # Update
            store = Store.query.get(store_id)
            if store and store.subsite_id == subsite_id:
                store.name = name
                db.session.commit()
                flash('Loja atualizada.', 'success')
        else: # Create
            new_store = Store(name=name, subsite_id=subsite_id, active=True)
            db.session.add(new_store)
            db.session.commit()
            flash('Loja criada.', 'success')
        return redirect(url_for('admin.stores'))

    stores = Store.query.filter_by(subsite_id=subsite_id).all()
    return render_template('admin_stores.html', stores=stores)

@admin_bp.route('/store/<int:store_id>/delete', methods=['POST'])
def delete_store(store_id):
    store = Store.query.get_or_404(store_id)
    # Check perm
    # (Simplified for brevity, ideally check subsite_id)
    db.session.delete(store)
    db.session.commit()
    flash('Loja excluída.', 'success')
    return redirect(url_for('admin.stores'))

@admin_bp.route('/items', methods=['GET', 'POST'])
def items():
    from flask import session
    subsite_id = current_user.subsite_id
    if current_user.role == 'admin_master':
    flash('Item excluído.', 'success')
    return redirect(url_for('admin.items'))

@admin_bp.route('/item/<int:item_id>/toggle', methods=['POST'])
def toggle_item(item_id):
    from flask import session
    item = Item.query.get_or_404(item_id)
    
    # Check permission
    subsite_id = current_user.subsite_id
    if current_user.role == 'admin_master':
        subsite_id = session.get('master_subsite_id')

    if item.subsite_id != subsite_id:
        return "Unauthorized", 403
        
    item.available = not item.available
    db.session.commit()
    return redirect(url_for('admin.items'))
